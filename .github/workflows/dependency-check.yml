name: Dependency Security Check

on:
  # ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ
  workflow_dispatch:
  
  # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
  push:
    paths:
      - 'pyproject.toml'
      - 'uv.lock'
      - 'requirements*.txt'
  
  pull_request:
    paths:
      - 'pyproject.toml'
      - 'uv.lock'
      - 'requirements*.txt'

jobs:
  dependency-check:
    name: ğŸ” Security Scan Dependencies
    runs-on: ubuntu-latest
    
    permissions:
      # ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ security advisories
      security-events: write
      # ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ issues
      issues: write
      # ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ´Ğ»Ñ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
      contents: read
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: ğŸ“¦ Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"
      
      - name: ğŸ”§ Install dependencies
        run: |
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
          uv sync --frozen
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
          uv pip install --system safety pip-audit bandit
      
      - name: ğŸ›¡ï¸ Run Safety check
        id: safety
        run: |
          echo "## ğŸ›¡ï¸ Safety Vulnerability Report" >> $GITHUB_STEP_SUMMARY
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ½Ğ° Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğµ ÑƒÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
          if safety check --json --output safety-report.json; then
            echo "âœ… No known vulnerabilities found by Safety" >> $GITHUB_STEP_SUMMARY
            echo "safety_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Safety found vulnerabilities" >> $GITHUB_STEP_SUMMARY
            echo "safety_status=failure" >> $GITHUB_OUTPUT
            
            # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ² summary
            echo "### Safety Report Details:" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat safety-report.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true
      
      - name: ğŸ” Run pip-audit
        id: pip_audit
        run: |
          echo "## ğŸ” pip-audit Vulnerability Report" >> $GITHUB_STEP_SUMMARY
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ pip-audit
          if pip-audit --format=json --output=pip-audit-report.json; then
            echo "âœ… No vulnerabilities found by pip-audit" >> $GITHUB_STEP_SUMMARY
            echo "pip_audit_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ pip-audit found vulnerabilities" >> $GITHUB_STEP_SUMMARY
            echo "pip_audit_status=failure" >> $GITHUB_OUTPUT
            
            # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ² summary
            echo "### pip-audit Report Details:" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat pip-audit-report.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true
      
      - name: ğŸ”’ Run Bandit security check
        id: bandit
        run: |
          echo "## ğŸ”’ Bandit Security Analysis" >> $GITHUB_STEP_SUMMARY
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ¾Ğ´ Ğ½Ğ° Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
          if bandit -r src/ -f json -o bandit-report.json -ll; then
            echo "âœ… No security issues found by Bandit" >> $GITHUB_STEP_SUMMARY
            echo "bandit_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Bandit found security issues" >> $GITHUB_STEP_SUMMARY
            echo "bandit_status=failure" >> $GITHUB_OUTPUT
            
            # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºÑ€Ğ°Ñ‚ĞºĞ¸Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ² summary
            echo "### Bandit Report Summary:" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            jq '.results[] | {filename: .filename, test_name: .test_name, issue_severity: .issue_severity, issue_text: .issue_text}' bandit-report.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true
      
      - name: ğŸ“Š Generate security summary
        run: |
          echo "## ğŸ“Š Security Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Safety | ${{ steps.safety.outputs.safety_status == 'success' && 'âœ… Pass' || 'âŒ Fail' }} | Checks for known vulnerabilities in dependencies |" >> $GITHUB_STEP_SUMMARY
          echo "| pip-audit | ${{ steps.pip_audit.outputs.pip_audit_status == 'success' && 'âœ… Pass' || 'âŒ Fail' }} | OSV database vulnerability scanner |" >> $GITHUB_STEP_SUMMARY
          echo "| Bandit | ${{ steps.bandit.outputs.bandit_status == 'success' && 'âœ… Pass' || 'âŒ Fail' }} | Static security analysis for Python code |" >> $GITHUB_STEP_SUMMARY
          
          # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ’¡ Recommendations:" >> $GITHUB_STEP_SUMMARY
          echo "- Review and update vulnerable dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- Check for alternative packages if fixes aren't available" >> $GITHUB_STEP_SUMMARY
          echo "- Consider pinning versions for critical dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- Run \`uv sync --upgrade\` to update to latest versions" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ“¤ Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            safety-report.json
            pip-audit-report.json
            bandit-report.json
          retention-days: 30
      
      - name: ğŸš¨ Create issue on vulnerability found
        if: |
          steps.safety.outputs.safety_status == 'failure' ||
          steps.pip_audit.outputs.pip_audit_status == 'failure' ||
          steps.bandit.outputs.bandit_status == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸš¨ Security vulnerabilities detected - ${new Date().toISOString().split('T')[0]}`;
            const body = `## ğŸš¨ Security Alert
            
            Automated security scan detected potential vulnerabilities in the project dependencies or code.
            
            ### ğŸ“‹ Scan Results:
            - **Safety**: ${{ steps.safety.outputs.safety_status }}
            - **pip-audit**: ${{ steps.pip_audit.outputs.pip_audit_status }}
            - **Bandit**: ${{ steps.bandit.outputs.bandit_status }}
            
            ### ğŸ”— Workflow Run:
            [View detailed results](${context.payload.repository.html_url}/actions/runs/${context.runId})
            
            ### ğŸ“¥ Security Reports:
            Download the detailed reports from the workflow artifacts.
            
            ### ğŸ› ï¸ Next Steps:
            1. Review the detailed security reports
            2. Update vulnerable dependencies: \`uv sync --upgrade\`
            3. Apply security patches where available
            4. Consider alternative packages if no fixes are available
            5. Close this issue once all issues are resolved
            
            ### ğŸ“š Resources:
            - [Safety Documentation](https://pyup.io/safety/)
            - [pip-audit Documentation](https://pypi.org/project/pip-audit/)
            - [Bandit Documentation](https://bandit.readthedocs.io/)
            
            ---
            *This issue was automatically created by the dependency check workflow.*
            `;
            
            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ĞµÑÑ‚ÑŒ Ğ»Ğ¸ ÑƒĞ¶Ğµ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¹ issue Ñ Ñ‚Ğ°ĞºĞ¸Ğ¼ Ğ¶Ğµ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¾Ğ¼
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['security', 'dependencies']
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('Security vulnerabilities detected')
            );
            
            if (existingIssue) {
              // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## ğŸ”„ Updated Security Scan Results\n\n${body}`
              });
            } else {
              // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'dependencies', 'automated']
              });
            }
      
      - name: âœ… Report success
        if: |
          steps.safety.outputs.safety_status == 'success' &&
          steps.pip_audit.outputs.pip_audit_status == 'success' &&
          steps.bandit.outputs.bandit_status == 'success'
        run: |
          echo "ğŸ‰ All security checks passed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "No known vulnerabilities found in dependencies or code." >> $GITHUB_STEP_SUMMARY
      
      - name: âŒ Fail on critical vulnerabilities
        if: |
          steps.safety.outputs.safety_status == 'failure' ||
          steps.pip_audit.outputs.pip_audit_status == 'failure'
        run: |
          echo "âŒ Critical security vulnerabilities detected!"
          echo "Please review the security reports and update vulnerable dependencies."
          exit 1
